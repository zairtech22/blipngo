<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title><%= biz.name %> — AI Review Settings</title>
<style>
  :root{ 
    --ink:#0A0A0A; 
    --muted:#6b7280; 
    --bg:#f8fafc; 
    --paper:#fff; 
    --border:#e5e7eb; 
    --brand:#0A0A0A; 
    --cta:#0A0A0A; 
    --cta-fg:#fff;
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }
  *{box-sizing:border-box} 
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    line-height:1.5;
  }
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 24px;
    background:#fff;
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    z-index:20;
    box-shadow:var(--shadow);
  }
  h1{margin:0;font-size:20px;letter-spacing:-0.01em}
  .hint{color:var(--muted);font-size:13px}
  .btn{
    border:1px solid transparent;
    background:var(--brand);
    color:#fff;
    padding:10px 16px;
    border-radius:8px;
    font-weight:600;
    text-decoration:none;
    display:inline-block;
    cursor:pointer;
    transition:all 0.2s ease;
  }
  .btn:hover{
    transform:translateY(-1px);
    box-shadow:var(--shadow);
  }
  .btn.secondary{
    background:#fff;
    border:1px solid var(--border);
    color:var(--ink)
  }
  .btn.secondary:hover {
    background: #f8fafc;
  }
  main{
    max-width:1200px;
    margin:0 auto;
    padding:24px;
    display:grid;
    gap:24px
  }
  .layout{
    display:grid;
    grid-template-columns:1fr 360px;
    gap:24px;
    align-items:start
  }
  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    box-shadow:var(--shadow);
    transition:box-shadow 0.2s ease;
  }
  .card h3{
    margin:0 0 16px 0;
    font-size:18px;
    letter-spacing:-0.01em;
    color:var(--ink);
    font-weight:600
  }
  .card.small{
    padding:16px
  }
  .card .lead{
    color:var(--muted);
    font-size:14px;
    margin-bottom:16px;
    line-height:1.5
  }
  fieldset{
    border:0;
    margin:0;
    padding:0
  }
  .field-legend{
    font-weight:600;
    margin-bottom:12px;
    color:var(--ink)
  }
  .help{
    color:var(--muted);
    font-size:13px;
    margin-top:8px
  }
  .toggle{
    display:inline-flex;
    align-items:center;
    gap:10px;
    margin:12px 0
  }
  .switch{width:44px;height:24px;background:#e6e7eb;border-radius:999px;position:relative;display:inline-block;cursor:pointer}
  .switch .knob{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:all .18s}
  .switch.on{background:var(--ink)}
  .switch.on .knob{left:23px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{
    display:block;
    font-weight:600;
    margin:12px 0 8px;
    color:var(--ink)
  }
  input[type="text"], input[type="url"], textarea, select, input[type="number"]{
    width:100%;
    padding:12px 16px;
    border:1px solid #e2e8f0;
    border-radius:8px;
    background:#fff;
    font:inherit;
    transition:all 0.2s ease
  }
  input[type="text"]:focus, input[type="url"]:focus, textarea:focus, select:focus, input[type="number"]:focus {
    outline:none;
    border-color:var(--ink);
    box-shadow:0 0 0 3px rgb(0 0 0 / 0.1)
  }
  textarea{
    resize:vertical;
    min-height:120px
  }
  .savebar{
    position:sticky;
    bottom:24px;
    background:#ffffffee;
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    display:flex;
    justify-content:flex-end;
    gap:12px;
    backdrop-filter:saturate(1.1) blur(4px);
    box-shadow:var(--shadow)
  }
  .grid{
    display:grid;
    gap:12px
  }
  .qrbox{
    border:1px dashed var(--border);
    border-radius:10px;
    background:#fff;
    display:grid;
    place-items:center;
    padding:20px;
    box-shadow:var(--shadow)
  }
  .muted{color:var(--muted);font-size:13px}

  .preview-card{
    background:linear-gradient(180deg,#fff,#f8fafc);
    border:1px solid var(--border);
    padding:16px;
    border-radius:10px;
    text-align:center;
    box-shadow:var(--shadow);
    transition:transform 0.2s ease
  }
  .preview-card:hover {
    transform:translateY(-2px)
  }
  .preview-head{
    font-weight:700;
    margin-bottom:8px;
    color:var(--ink)
  }
  .preview-sub{
    color:var(--muted);
    font-size:14px;
    line-height:1.4
  }

  /* responsive */
  @media (max-width: 1024px){ 
    .layout{
      grid-template-columns:1fr
    }
    main {
      padding:16px
    }
  }
</style>
</head>
<body>
<header>
  <div>
    <h1><strong><%= biz.name %></strong> <span class="hint">/ AI Reviews</span></h1>
    <div class="hint">Manage the single-platform AI poster & settings.</div>
  </div>
  <div>
    <a class="btn secondary" href="/business/<%= biz.slug %>">Back</a>
    <a class="btn secondary" href="/">All</a>
  </div>
</header>

<main>
  <div class="layout">
    <form method="post" action="/admin/ai/<%= biz.slug %>/save">
    <div class="card">
      <h3>Poster Settings</h3>
      <div class="row">
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="google" <%= (cfg.platform==='google'?'selected':'') %>>Google</option>
          </select>
          <div class="hint">Single platform per AI poster.</div>
        </div>
        <div>
            <label>Google Review Link</label>
            <input name="googleReviewUrl" type="url" value="<%= targetUrl || '' %>" placeholder="https://search.google.com/local/writereview?placeid=XXXX"/>
            <div class="hint">Paste the business’s direct “Write a review” URL.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Poster Headline</label>
          <input name="headline" type="text" value="<%= cfg.headline || '' %>" placeholder="We’ll draft it for you — edit & paste"/>
        </div>
        <div>
          <label>Disclaimer</label>
          <input name="disclaimer" type="text" value="<%= cfg.disclaimer || '' %>" placeholder="Reviews are optional and appreciated."/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Default Tone</label>
          <select name="defaultTone">
            <option value="">(none)</option>
            <option value="friendly"     <%= cfg.defaultTone==='friendly'?'selected':'' %>>Friendly</option>
            <option value="professional" <%= cfg.defaultTone==='professional'?'selected':'' %>>Professional</option>
            <option value="enthusiastic" <%= cfg.defaultTone==='enthusiastic'?'selected':'' %>>Enthusiastic</option>
          </select>
        </div>
        <div>
          <label>Default Length</label>
          <select name="defaultLength">
            <option value="">(none)</option>
            <option value="short"  <%= cfg.defaultLength==='short'?'selected':'' %>>Short</option>
            <option value="medium" <%= cfg.defaultLength==='medium'?'selected':'' %>>Medium</option>
            <option value="long"   <%= cfg.defaultLength==='long'?'selected':'' %>>Long</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>LLM (optional)</h3>
      <div class="lead">Use an LLM to draft suggested reviews automatically.</div>
      <div class="toggle">
        <div class="switch <%= cfg.llmEnabled ? 'on' : '' %>" id="llmSwitch" data-on="<%= cfg.llmEnabled ? '1' : '0' %>"></div>
        <label style="margin:0">Enable LLM</label>
      </div>
      <input type="hidden" name="llmEnabled" value="<%= cfg.llmEnabled ? '1' : '0' %>" id="llmEnabledInput" />
      <div class="row" id="llmRows">
        <div>
          <label>Provider</label>
          <input name="llmProvider" type="text" value="<%= cfg.llmProvider || '' %>" placeholder="openai"/>
        </div>
        <div>
          <label>Model</label>
          <input name="llmModel" type="text" value="<%= cfg.llmModel || '' %>" placeholder="gpt-4o-mini"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Temperature</label>
          <input name="llmTemp" type="number" step="0.1" min="0" max="1" value="<%= typeof cfg.llmTemp==='number' ? cfg.llmTemp : '' %>"/>
        </div>
        <div></div>
      </div>
      <label>System Prompt</label>
      <textarea name="llmSystem" placeholder="You are a helpful assistant that drafts sincere customer feedback…"><%= cfg.llmSystem || '' %></textarea>
    </div>

    <div class="savebar">
      <a class="btn secondary" href="/business/<%= biz.slug %>">Cancel</a>
      <button class="btn" type="submit">Save Settings</button>
    </div>
    </form>

    <aside>
      <div class="card small">
        <h3>QR Preview</h3>
        <div class="qr-container">
          <div class="qrbox">
            <img id="qrImg" src="/qr/ai/<%= biz.slug %>/<%= cfg.platform %>.png" width="220" alt="QR Code Preview"/>
          </div>
          <div class="qr-actions-group">
            <div class="qr-actions">
              <button id="refreshQr" class="btn secondary icon-button" type="button" title="Refresh QR Code">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-1.7-5.3L23 10"></path>
                </svg>
              </button>
              <button id="downloadQr" class="btn secondary icon-button" type="button" title="Download QR Code">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 15L12 3M12 15L8 11M12 15L16 11" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19L22 17" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <div class="link-actions">
              <div class="link-group">
                <input type="hidden" id="posterUrl" value="<%= `${BASE_URL}/ai-poster/${biz.slug}/${cfg.platform}` %>" />
                <a class="btn secondary icon-button" target="_blank" href="<%= `${BASE_URL}/ai-poster/${biz.slug}/${cfg.platform}` %>" title="Open Poster">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3H8C6.34315 3 5 4.34315 5 6V18C5 19.6569 6.34315 21 8 21H16C17.6569 21 19 19.6569 19 18V10M12 3L19 10M12 3V9C12 9.55228 12.4477 10 13 10H19" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
                <button id="copyPoster" class="btn secondary icon-button" type="button" title="Copy Poster URL">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 5H6C4.89543 5 4 5.89543 4 7V19C4 20.1046 4.89543 21 6 21H16C17.1046 21 18 20.1046 18 19V17M8 5C8 3.89543 8.89543 3 10 3H16C17.1046 3 18 3.89543 18 5V17M8 5V17C8 18.1046 8.89543 19 10 19H18" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>

              <div class="link-group">
                <input type="hidden" id="formUrl" value="<%= `${BASE_URL}/ai-review/${biz.slug}?platform=${cfg.platform}` %>" />
                <a class="btn secondary icon-button" target="_blank" href="<%= `${BASE_URL}/ai-review/${biz.slug}?platform=${cfg.platform}` %>" title="Open Form">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
                <button id="copyForm" class="btn secondary icon-button" type="button" title="Copy Form URL">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 5H6C4.89543 5 4 5.89543 4 7V19C4 20.1046 4.89543 21 6 21H16C17.1046 21 18 20.1046 18 19V17M8 5C8 3.89543 8.89543 3 10 3H16C17.1046 3 18 3.89543 18 5V17M8 5V17C8 18.1046 8.89543 19 10 19H18" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>
        .qr-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
        }
        .qrbox {
          padding: 24px;
          border: 1px solid var(--border);
          border-radius: 12px;
          background: #fff;
          box-shadow:var(--shadow);
        }
        .qr-actions-group {
          display: flex;
          flex-direction: column;
          gap: 16px;
          width: 100%;
        }
        .qr-actions {
          display: flex;
          gap: 12px;
          justify-content: center;
          padding-bottom: 8px;
          border-bottom: 1px solid var(--border);
        }
        .link-actions {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        .link-group {
          display: flex;
          gap: 8px;
          justify-content: center;
        }
        .icon-button {
          width: 44px;
          height: 44px;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 10px;
        }
        .icon-button svg {
          transition: all 0.2s ease;
        }
        #refreshQr:hover svg {
          transform: rotate(180deg);
        }
        .icon-button:hover svg {
          transform: scale(1.1);
        }
        .link-group .icon-button {
          width: 38px;
          height: 38px;
        }
        @media (max-width: 1024px) {
          .qr-section {
            grid-template-columns: 1fr;
          }
          .qrbox {
            justify-self: center;
          }
        }
      </style>

      <div class="card small">
        <h3>Quick Tips</h3>
        <ol class="muted" style="margin:8px 0 0 18px">
          <li>Scan the QR to open the review helper</li>
          <li>Pick a tone & length, then edit the draft</li>
          <li>Copy & paste to the review page — thank you!</li>
        </ol>
      </div>
    </aside>
  </div>
</main>

<script>
(function(){
  try{
    const plat = document.querySelector('select[name="platform"]');
    const posterUrl = document.getElementById('posterUrl');
    const formUrl   = document.getElementById('formUrl');
    const openPoster= document.getElementById('openPoster');
    const openForm  = document.getElementById('openForm');
    const copyPoster= document.getElementById('copyPoster');
    const copyForm  = document.getElementById('copyForm');
    const qrImg     = document.getElementById('qrImg');

    function update(){
      if(!plat) return;
      const p = plat.value;
      const poster = (typeof BASE_URL!=='undefined' ? BASE_URL : '') + '/ai-poster/' + '<%= biz.slug %>' + '/' + p;
      const form   = (typeof BASE_URL!=='undefined' ? BASE_URL : '') + '/ai-review/' + '<%= biz.slug %>' + '?platform=' + p;
      if(posterUrl) posterUrl.value = poster;
      if(openPoster) openPoster.href = poster;
      if(formUrl) formUrl.value   = form;
      if(openForm) openForm.href   = form;
      if(qrImg) qrImg.src = '/qr/ai/' + '<%= biz.slug %>' + '/' + p + '.png?ts=' + Date.now();
    }

    async function copy(btn, text){
      try { await navigator.clipboard.writeText(text); const old=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,900); }
      catch { alert('Copy failed — copy manually.'); }
    }

    if(copyPoster && posterUrl) copyPoster.addEventListener('click', ()=>copy(copyPoster, posterUrl.value));
    if(copyForm && formUrl) copyForm.addEventListener('click', ()=>copy(copyForm, formUrl.value));

    // QR download functionality
    const downloadQr = document.getElementById('downloadQr');
    if(downloadQr && qrImg) {
      downloadQr.addEventListener('click', async () => {
        try {
          const response = await fetch(qrImg.src);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = 'qr-code.png';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          downloadQr.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"></path></svg>';
          setTimeout(() => {
            downloadQr.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15L12 3M12 15L8 11M12 15L16 11" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17L2 19C2 20.1046 2.89543 21 4 21L20 21C21.1046 21 22 20.1046 22 19L22 17" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          }, 1000);
        } catch (err) {
          console.error('Failed to download QR code:', err);
          alert('Failed to download QR code. Please try again.');
        }
      });
    }

    // headline live preview
    const headlineInput = document.querySelector('input[name="headline"]');
    const disclaimerInput = document.querySelector('input[name="disclaimer"]');
    const previewHeadline = document.getElementById('previewHeadline');
    const previewSub = document.getElementById('previewSub');
    if(headlineInput && previewHeadline){ headlineInput.addEventListener('input', e=>{ previewHeadline.textContent = e.target.value || 'Preview headline will show here' }) }
    if(disclaimerInput && previewSub){ disclaimerInput.addEventListener('input', e=>{ previewSub.textContent = e.target.value || 'Optional disclaimer text' }) }

    // refresh QR
    const refreshBtn = document.getElementById('refreshQr');
    if(refreshBtn && qrImg){ refreshBtn.addEventListener('click', ()=>{ const sel = document.querySelector('select[name="platform"]'); const p = sel?sel.value: '<%= cfg.platform %>'; qrImg.src = '/qr/ai/' + '<%= biz.slug %>' + '/' + p + '.png?ts=' + Date.now(); refreshBtn.textContent='Refreshing...'; setTimeout(()=>refreshBtn.textContent='Refresh QR',800) }) }

    // LLM toggle behavior
    const llmSwitch = document.getElementById('llmSwitch');
    const llmEnabledInput = document.getElementById('llmEnabledInput');
    const llmRows = document.getElementById('llmRows');
    function setLlm(enabled){ if(!llmSwitch || !llmEnabledInput || !llmRows) return; if(enabled){ llmSwitch.classList.add('on'); llmEnabledInput.value='1'; llmRows.style.opacity='1'; llmRows.style.pointerEvents='auto' } else { llmSwitch.classList.remove('on'); llmEnabledInput.value='0'; llmRows.style.opacity='0.45'; llmRows.style.pointerEvents='none' } }
    if(llmSwitch){ llmSwitch.addEventListener('click', ()=>{ const on = llmEnabledInput.value!=='1'; setLlm(on) }); setLlm(llmEnabledInput.value==='1'); }

    // also update urls when platform changes
    if(plat){ plat.addEventListener('change', update); }
    // initial update
    update();
  }catch(err){ console.error('AI admin init error', err); }
})();
</script>
</body>
</html>
