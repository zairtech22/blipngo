<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title><%= biz.name %> — AI Review Settings</title>
<style>
  :root{ --ink:#0A0A0A; --muted:#6b7280; --bg:#f6f7f8; --paper:#fff; --border:#e5e7eb; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  h1{margin:0;font-size:18px}
  .hint{color:var(--muted);font-size:12px}
  .btn{border:2px solid #000;background:#fff;color:#000;padding:8px 12px;border-radius:10px;font-weight:700;text-decoration:none;display:inline-block;cursor:pointer}
  .btn:hover{background:#000;color:#fff}
  .btn.secondary{border-color:#888;color:#222}
  main{max-width:1100px;margin:0 auto;padding:18px;display:grid;gap:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px}
  .card h3{margin:0 0 10px 0;font-size:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:700;margin:8px 0 6px}
  input[type="text"], input[type="url"], textarea, select, input[type="number"]{
    width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font:inherit
  }
  textarea{resize:vertical;min-height:100px}
  .savebar{position:sticky;bottom:0;background:#ffffffd9;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;justify-content:flex-end;gap:10px;backdrop-filter:saturate(1.1) blur(2px)}
  .grid{display:grid;gap:10px}
  .qrbox{border:1px solid var(--border);border-radius:10px;background:#fff;display:grid;place-items:center;padding:8px}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div>
    <h1><strong><%= biz.name %></strong> <span class="hint">/ AI Reviews</span></h1>
    <div class="hint">Manage the single-platform AI poster & settings.</div>
  </div>
  <div>
    <a class="btn secondary" href="/business/<%= biz.slug %>">Back</a>
    <a class="btn secondary" href="/">All</a>
  </div>
</header>

<main>
  <form method="post" action="/admin/ai/<%= biz.slug %>/save">
    <div class="card">
      <h3>Poster Settings</h3>
      <div class="row">
        <div>
          <label>Platform</label>
          <select name="platform">
            <option value="google" <%= (cfg.platform==='google'?'selected':'') %>>Google</option>
          </select>
          <div class="hint">Single platform per AI poster.</div>
        </div>
        <div>
            <label>Google Review Link</label>
            <input name="googleReviewUrl" type="url" value="<%= targetUrl || '' %>" placeholder="https://search.google.com/local/writereview?placeid=XXXX"/>
            <div class="hint">Paste the business’s direct “Write a review” URL.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>AI Poster URL</label>
          <input id="posterUrl" type="text" readonly value="<%= `${BASE_URL}/ai-poster/${biz.slug}/${cfg.platform}` %>" />
          <div class="grid" style="grid-template-columns:auto auto;align-items:center">
            <a id="openPoster" class="btn" target="_blank" href="<%= `${BASE_URL}/ai-poster/${biz.slug}/${cfg.platform}` %>">Open Poster</a>
            <button id="copyPoster" class="btn" type="button">Copy Link</button>
          </div>
        </div>
        <div>
          <label>Review Form URL</label>
          <input id="formUrl" type="text" readonly value="<%= `${BASE_URL}/ai-review/${biz.slug}?platform=${cfg.platform}` %>" />
          <div class="grid" style="grid-template-columns:auto auto;align-items:center">
            <a id="openForm" class="btn secondary" target="_blank" href="<%= `${BASE_URL}/ai-review/${biz.slug}?platform=${cfg.platform}` %>">Open Form</a>
            <button id="copyForm" class="btn" type="button">Copy Link</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Poster Headline</label>
          <input name="headline" type="text" value="<%= cfg.headline || '' %>" placeholder="We’ll draft it for you — edit & paste"/>
        </div>
        <div>
          <label>Disclaimer</label>
          <input name="disclaimer" type="text" value="<%= cfg.disclaimer || '' %>" placeholder="Reviews are optional and appreciated."/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Default Tone</label>
          <select name="defaultTone">
            <option value="">(none)</option>
            <option value="friendly"     <%= cfg.defaultTone==='friendly'?'selected':'' %>>Friendly</option>
            <option value="professional" <%= cfg.defaultTone==='professional'?'selected':'' %>>Professional</option>
            <option value="enthusiastic" <%= cfg.defaultTone==='enthusiastic'?'selected':'' %>>Enthusiastic</option>
          </select>
        </div>
        <div>
          <label>Default Length</label>
          <select name="defaultLength">
            <option value="">(none)</option>
            <option value="short"  <%= cfg.defaultLength==='short'?'selected':'' %>>Short</option>
            <option value="medium" <%= cfg.defaultLength==='medium'?'selected':'' %>>Medium</option>
            <option value="long"   <%= cfg.defaultLength==='long'?'selected':'' %>>Long</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>LLM (optional)</h3>
      <label class="inline">
        <input type="checkbox" name="llmEnabled" <%= cfg.llmEnabled ? 'checked' : '' %> /> Enable
      </label>
      <div class="row">
        <div>
          <label>Provider</label>
          <input name="llmProvider" type="text" value="<%= cfg.llmProvider || '' %>" placeholder="openai"/>
        </div>
        <div>
          <label>Model</label>
          <input name="llmModel" type="text" value="<%= cfg.llmModel || '' %>" placeholder="gpt-4o-mini"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Temperature</label>
          <input name="llmTemp" type="number" step="0.1" min="0" max="1" value="<%= typeof cfg.llmTemp==='number' ? cfg.llmTemp : '' %>"/>
        </div>
        <div></div>
      </div>
      <label>System Prompt</label>
      <textarea name="llmSystem" placeholder="You are a helpful assistant that drafts sincere customer feedback…"><%= cfg.llmSystem || '' %></textarea>
    </div>

    <div class="savebar">
      <a class="btn secondary" href="/business/<%= biz.slug %>">Cancel</a>
      <button class="btn" type="submit">Save Settings</button>
    </div>
  </form>

  <div class="card">
    <h3>QR Preview</h3>
    <div class="row">
      <div class="qrbox"><img id="qrImg" src="/qr/ai/<%= biz.slug %>/<%= cfg.platform %>.png" width="180"/></div>
      <div class="muted">
        Scan → Review Form:<br/>
        <code>/ai-review/<%= biz.slug %>?platform=<%= cfg.platform %></code>
      </div>
    </div>
  </div>
</main>

<script>
(function(){
  const plat = document.querySelector('select[name="platform"]');
  const posterUrl = document.getElementById('posterUrl');
  const formUrl   = document.getElementById('formUrl');
  const openPoster= document.getElementById('openPoster');
  const openForm  = document.getElementById('openForm');
  const copyPoster= document.getElementById('copyPoster');
  const copyForm  = document.getElementById('copyForm');
  const qrImg     = document.getElementById('qrImg');

  function update(){
    const p = plat.value;
    const poster = `${BASE_URL}/ai-poster/${'<%= biz.slug %>'}/${p}`;
    const form   = `${BASE_URL}/ai-review/${'<%= biz.slug %>'}?platform=${p}`;
    posterUrl.value = poster; openPoster.href = poster;
    formUrl.value   = form;  openForm.href   = form;
    qrImg.src = `/qr/ai/${'<%= biz.slug %>'}/${p}.png?ts=` + Date.now();
  }

  async function copy(btn, text){
    try { await navigator.clipboard.writeText(text); const old=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,900); }
    catch { alert('Copy failed — copy manually.'); }
  }

  copyPoster.addEventListener('click', ()=>copy(copyPoster, posterUrl.value));
  copyForm.addEventListener('click', ()=>copy(copyForm, formUrl.value));
})();
</script>
</body>
</html>
